<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ—Å—Ç—ã –∏–∑ —Ç–µ–ª–µ–≥—Ä–∞–º-–∫–∞–Ω–∞–ª–∞ –∞–¥–≤–æ–∫–∞—Ç–∞ –í–∞–ª–µ—Ä–∏—è –§–µ–¥–æ—Ä–æ–≤–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f0f2f5;
            color: #1a1a1a;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #2AABEE, #229ED9);
            color: white;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .header a {
            color: white;
            text-decoration: none;
            border-bottom: 1px dashed rgba(255,255,255,0.5);
        }

        .header a:hover {
            border-bottom-color: white;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 20px 15px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .search-box:focus {
            border-color: #2AABEE;
            box-shadow: 0 0 0 3px rgba(42, 171, 238, 0.1);
        }

        .post-count {
            font-size: 13px;
            color: #888;
            white-space: nowrap;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .loading .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e0e0e0;
            border-top-color: #2AABEE;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading p {
            color: #888;
            font-size: 15px;
        }

        .error {
            text-align: center;
            padding: 40px 20px;
            color: #e74c3c;
        }

        .error button {
            margin-top: 15px;
            padding: 10px 25px;
            background: #2AABEE;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .post-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            transition: box-shadow 0.2s;
        }

        .post-card:hover {
            box-shadow: 0 3px 12px rgba(0,0,0,0.12);
        }

        .post-date {
            font-size: 12px;
            color: #999;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .post-date a {
            color: #2AABEE;
            text-decoration: none;
            font-size: 12px;
        }

        .post-date a:hover {
            text-decoration: underline;
        }

        .post-text {
            font-size: 15px;
            line-height: 1.7;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .post-text a {
            color: #2AABEE;
            text-decoration: none;
        }

        .post-text a:hover {
            text-decoration: underline;
        }

        .post-text b, .post-text strong {
            font-weight: 600;
        }

        .post-text blockquote {
            border-left: 3px solid #2AABEE;
            margin: 10px 0;
            padding: 5px 15px;
            background: #f8f9fa;
            border-radius: 0 8px 8px 0;
        }

        .post-text pre, .post-text code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 13px;
        }

        .post-text pre {
            padding: 12px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .post-media {
            margin-top: 12px;
            border-radius: 8px;
            overflow: hidden;
        }

        .post-media img {
            width: 100%;
            display: block;
            border-radius: 8px;
        }

        .post-media video {
            width: 100%;
            display: block;
            border-radius: 8px;
        }

        .post-views {
            font-size: 12px;
            color: #bbb;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .post-views svg {
            width: 14px;
            height: 14px;
            fill: #bbb;
        }

        .load-more {
            display: block;
            width: 100%;
            padding: 14px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            color: #2AABEE;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 30px;
        }

        .load-more:hover {
            background: #2AABEE;
            color: white;
            border-color: #2AABEE;
        }

        .load-more:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 15px;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #aaa;
            font-size: 12px;
        }

        .footer a {
            color: #2AABEE;
            text-decoration: none;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ */
        .post-text .tg-spoiler {
            background: #333;
            color: #333;
            border-radius: 4px;
            padding: 0 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .post-text .tg-spoiler.revealed {
            background: transparent;
            color: inherit;
        }

        .hashtag {
            color: #2AABEE;
            font-weight: 500;
        }

        /* –°–∫—Ä–æ–ª–ª –Ω–∞–≤–µ—Ä—Ö */
        .scroll-top {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 45px;
            height: 45px;
            background: #2AABEE;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s;
            z-index: 99;
        }

        .scroll-top.visible {
            display: flex;
        }

        @media (max-width: 480px) {
            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 20px;
            }

            .post-card {
                padding: 15px;
                border-radius: 10px;
            }

            .container {
                padding: 15px 10px;
            }
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>üì¢–ê–¥–≤–æ–∫–∞—Ç –í–∞–ª–µ—Ä–∏–π –§–µ–¥–æ—Ä–æ–≤</h1>
        <p>–ü–æ—Å—Ç—ã –∏–∑ Telegram-–∫–∞–Ω–∞–ª–∞ <a href="https://t.me/adv_vfedorov" target="_blank">@adv_vfedorov</a></p>
    </div>

    <div class="container">
        <div class="controls">
            <input type="text" class="search-box" id="searchBox" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –ø–æ—Å—Ç–∞–º...">
            <span class="post-count" id="postCount"></span>
        </div>

        <div id="postsContainer">
            <div class="loading" id="loadingIndicator">
                <div class="spinner"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...</p>
            </div>
        </div>

        <button class="load-more" id="loadMoreBtn" style="display:none;" onclick="loadMore()">
            –ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë
        </button>
    </div>

    <button class="scroll-top" id="scrollTopBtn" onclick="window.scrollTo({top:0,behavior:'smooth'})">‚Üë</button>

    <div class="footer">
        –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ <a href="https://t.me/adv_vfedorov" target="_blank">Telegram</a> —á–µ—Ä–µ–∑ RSS
    </div>

    <script>
        const CHANNEL = 'adv_vfedorov';
        const RSS_URL = `https://api.allorigins.win/raw?url=${encodeURIComponent(`https://rsshub.app/telegram/channel/${CHANNEL}`)}`;
        const CORS_PROXIES = [
            (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
            (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
            (url) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
        ];

        const RSS_SOURCES = [
            `https://rsshub.app/telegram/channel/${CHANNEL}`,
            `https://rss.app/feeds/v1.1/telegram-${CHANNEL}.xml`, // fallback
        ];

        let allPosts = [];
        let filteredPosts = [];
        let displayedCount = 0;
        const BATCH_SIZE = 20;

        // –ó–∞–≥—Ä—É–∑–∫–∞
        async function fetchWithFallback() {
           
            // –°—Ç—Ä–∞—Ç–µ–≥–∏—è 2: –ü–∞—Ä—Å–∏–Ω–≥ t.me/s/ –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏
            for (const proxyFn of CORS_PROXIES) {
                try {
                    const url = proxyFn(`https://t.me/s/${CHANNEL}`);
                    const response = await fetch(url, { signal: AbortSignal.timeout(10000) });
                    if (response.ok) {
                        const html = await response.text();
                        if (html.includes('tgme_widget_message')) {
                            return { type: 'html', data: html };
                        }
                    }
                } catch (e) {
                    console.log('HTML proxy failed, trying next...');
                }
            }

            throw new Error('All sources failed');
        }

        function parseRSS(xmlText) {
            const parser = new DOMParser();
            const xml = parser.parseFromString(xmlText, 'text/xml');
            const items = xml.querySelectorAll('item');
            const posts = [];

            items.forEach(item => {
                const title = item.querySelector('title')?.textContent || '';
                const description = item.querySelector('description')?.textContent || '';
                const link = item.querySelector('link')?.textContent || '';
                const pubDate = item.querySelector('pubDate')?.textContent || '';

                const content = description || title;
                if (!content.trim()) return;

                posts.push({
                    text: content,
                    date: pubDate ? new Date(pubDate) : new Date(),
                    link: link,
                    id: link.split('/').pop() || Math.random().toString()
                });
            });

            return posts;
        }

        function parseTelegramHTML(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const messages = doc.querySelectorAll('.tgme_widget_message');
            const posts = [];

            messages.forEach(msg => {
                const textEl = msg.querySelector('.tgme_widget_message_text');
                const dateEl = msg.querySelector('.tgme_widget_message_date time');
                const linkEl = msg.querySelector('.tgme_widget_message_date');
                const viewsEl = msg.querySelector('.tgme_widget_message_views');
                const photoEl = msg.querySelector('.tgme_widget_message_photo_wrap');
                const videoEl = msg.querySelector('video');

                let text = '';
                if (textEl) {
                    text = textEl.innerHTML;
                }

                let mediaUrl = '';
                let mediaType = '';
                if (photoEl) {
                    const style = photoEl.getAttribute('style') || '';
                    const match = style.match(/url\(['"]?(.*?)['"]?\)/);
                    if (match) {
                        mediaUrl = match[1];
                        mediaType = 'image';
                    }
                }
                if (videoEl) {
                    mediaUrl = videoEl.getAttribute('src') || '';
                    mediaType = 'video';
                }

                const dateStr = dateEl ? dateEl.getAttribute('datetime') : '';
                const link = linkEl ? linkEl.getAttribute('href') : '';
                const views = viewsEl ? viewsEl.textContent.trim() : '';

                if (!text && !mediaUrl) return;

                posts.push({
                    text: text,
                    date: dateStr ? new Date(dateStr) : new Date(),
                    link: link || `https://t.me/${CHANNEL}`,
                    views: views,
                    mediaUrl: mediaUrl,
                    mediaType: mediaType,
                    id: link ? link.split('/').pop() : Math.random().toString()
                });
            });

            return posts.reverse(); // –æ—Ç —Å—Ç–∞—Ä—ã—Ö –∫ –Ω–æ–≤—ã–º, –ø–æ—Ç–æ–º –ø–µ—Ä–µ–≤–µ—Ä–Ω—ë–º
        }

        function formatDate(date) {
            if (!(date instanceof Date) || isNaN(date)) return '';
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            return date.toLocaleDateString('ru-RU', options);
        }

        function sanitizeHTML(html) {
            // –†–∞–∑—Ä–µ—à–∞–µ–º –±–∞–∑–æ–≤—ã–µ —Ç–µ–≥–∏
            const tmp = document.createElement('div');
            tmp.innerHTML = html;

            // –£–¥–∞–ª—è–µ–º —Å–∫—Ä–∏–ø—Ç—ã
            tmp.querySelectorAll('script, style, iframe, object, embed').forEach(el => el.remove());

            return tmp.innerHTML;
        }

        function highlightSearch(text, query) {
            if (!query) return text;
            const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${escaped})`, 'gi');
            return text.replace(regex, '<mark style="background:#fff3cd;padding:1px 2px;border-radius:2px;">$1</mark>');
        }

        function renderPost(post, searchQuery) {
            const card = document.createElement('div');
            card.className = 'post-card';

            let textContent = sanitizeHTML(post.text);
            if (searchQuery) {
                textContent = highlightSearch(textContent, searchQuery);
            }

            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ö–µ—à—Ç–µ–≥–æ–≤
            textContent = textContent.replace(/(#\w+)/g, '<span class="hashtag">$1</span>');

            let mediaHTML = '';
            if (post.mediaUrl && post.mediaType === 'image') {
                mediaHTML = `<div class="post-media"><img src="${post.mediaUrl}" alt="–§–æ—Ç–æ" loading="lazy" onerror="this.parentElement.style.display='none'"></div>`;
            } else if (post.mediaUrl && post.mediaType === 'video') {
                mediaHTML = `<div class="post-media"><video src="${post.mediaUrl}" controls preload="none"></video></div>`;
            }

            let viewsHTML = '';
            if (post.views) {
                viewsHTML = `<div class="post-views">
                    <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                    ${post.views}
                </div>`;
            }

            card.innerHTML = `
                <div class="post-date">
                    <span>${formatDate(post.date)}</span>
                    <a href="${post.link}" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å –≤ Telegram ‚Üí</a>
                </div>
                <div class="post-text">${textContent}</div>
                ${mediaHTML}
                ${viewsHTML}
            `;

            return card;
        }

        function renderPosts(searchQuery = '') {
            const container = document.getElementById('postsContainer');
            container.innerHTML = '';
            displayedCount = 0;

            if (searchQuery) {
                const q = searchQuery.toLowerCase();
                filteredPosts = allPosts.filter(post => {
                    const plainText = post.text.replace(/<[^>]*>/g, '').toLowerCase();
                    return plainText.includes(q);
                });
            } else {
                filteredPosts = [...allPosts];
            }

            document.getElementById('postCount').textContent = `${filteredPosts.length} –ø–æ—Å—Ç–æ–≤`;

            if (filteredPosts.length === 0) {
                container.innerHTML = '<div class="no-results">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üòï</div>';
                document.getElementById('loadMoreBtn').style.display = 'none';
                return;
            }

            showBatch(searchQuery);
        }

        function showBatch(searchQuery = '') {
            const container = document.getElementById('postsContainer');
            const end = Math.min(displayedCount + BATCH_SIZE, filteredPosts.length);

            for (let i = displayedCount; i < end; i++) {
                container.appendChild(renderPost(filteredPosts[i], searchQuery));
            }

            displayedCount = end;

            const loadMoreBtn = document.getElementById('loadMoreBtn');
            if (displayedCount < filteredPosts.length) {
                loadMoreBtn.style.display = 'block';
                loadMoreBtn.textContent = `–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë (${filteredPosts.length - displayedCount} –æ—Å—Ç–∞–ª–æ—Å—å)`;
            } else {
                loadMoreBtn.style.display = 'none';
            }
        }

        function loadMore() {
            const searchQuery = document.getElementById('searchBox').value.trim();
            showBatch(searchQuery);
        }

        function showError(message) {
            const container = document.getElementById('postsContainer');
            container.innerHTML = `
                <div class="error">
                    <p>üòî ${message}</p>
                    <p style="font-size:13px;color:#999;margin-top:8px;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –∑–∞–π—Ç–∏ –ø–æ–∑–∂–µ</p>
                    <button onclick="location.reload()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                    <p style="margin-top:15px;font-size:13px;">
                        <a href="https://t.me/adv_vfedorov" target="_blank" style="color:#2AABEE;">
                            –û—Ç–∫—Ä—ã—Ç—å –∫–∞–Ω–∞–ª –≤ Telegram ‚Üí
                        </a>
                    </p>
                </div>
            `;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            try {
                const result = await fetchWithFallback();

                if (result && typeof result === 'object' && result.type === 'html') {
                    allPosts = parseTelegramHTML(result.data);
                } else if (typeof result === 'string') {
                    allPosts = parseRSS(result);
                }

                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É
                allPosts.sort((a, b) => b.date - a.date);

                document.getElementById('loadingIndicator').style.display = 'none';

                if (allPosts.length === 0) {
                    showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ—Å—Ç—ã');
                    return;
                }

                renderPosts();

            } catch (error) {
                console.error('Init error:', error);
                document.getElementById('loadingIndicator').style.display = 'none';

                // Fallback: –≤—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∏–¥–∂–µ—Ç Telegram
                showTelegramWidget();
            }
        }

        function showTelegramWidget() {
            const container = document.getElementById('postsContainer');
            container.innerHTML = `
                <div style="text-align:center; padding: 20px 0;">
                    <p style="color:#666; margin-bottom:20px; font-size:14px;">
                        –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –≤–∏–¥–∂–µ—Ç Telegram:
                    </p>
                </div>
                <div id="widgetPosts" style="max-width:100%;"></div>
            `;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 –ø–æ—Å—Ç–æ–≤ —á–µ—Ä–µ–∑ –≤–∏–¥–∂–µ—Ç
            for (let i = 0; i < 20; i++) {
                const wrapper = document.createElement('div');
                wrapper.style.marginBottom = '10px';
                wrapper.innerHTML = `
                    <script async src="https://telegram.org/js/telegram-widget.js?22"
                        data-telegram-post="${CHANNEL}/${getLatestPostId() - i}"
                        data-width="100%"
                        data-color="2AABEE"
                        data-dark-color="72BCFD">
                    <\/script>
                `;
                document.getElementById('widgetPosts').appendChild(wrapper);
            }

            // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –æ–¥–∏–Ω –≤–∏–¥–∂–µ—Ç —Å –æ–±—Å—É–∂–¥–µ–Ω–∏–µ–º
            const altWidget = document.createElement('script');
            altWidget.src = 'https://telegram.org/js/telegram-widget.js?22';
            altWidget.setAttribute('data-telegram-post', `${CHANNEL}/999999`);
            altWidget.setAttribute('data-width', '100%');
            altWidget.async = true;
        }

        function getLatestPostId() {
            // –ü—Ä–∏–º–µ—Ä–Ω—ã–π ID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ—Å—Ç–∞ ‚Äî –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è
            return 500;
        }

        // –ü–æ–∏—Å–∫ —Å debounce
        let searchTimeout;
        document.getElementById('searchBox').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                renderPosts(e.target.value.trim());
            }, 300);
        });

        // –ö–Ω–æ–ø–∫–∞ "–Ω–∞–≤–µ—Ä—Ö"
        window.addEventListener('scroll', () => {
            const btn = document.getElementById('scrollTopBtn');
            if (window.scrollY > 500) {
                btn.classList.add('visible');
            } else {
                btn.classList.remove('visible');
            }
        });

        // –°–ø–æ–π–ª–µ—Ä—ã
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('tg-spoiler')) {
                e.target.classList.toggle('revealed');
            }
        });

        // –ó–∞–ø—É—Å–∫
        init();
    </script>
</body>
</html>