<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ–ª–µ–≥—Ä–∞–º-–∫–∞–Ω–∞–ª –∞–¥–≤–æ–∫–∞—Ç–∞ –í–∞–ª–µ—Ä–∏—è –§–µ–¥–æ—Ä–æ–≤–∞</title>
   <link rel="stylesheet" href="style.css" />
   <script>
    // Apply theme before render to prevent flash
    (function () {
      var saved = localStorage.getItem('theme');
      var prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (saved === 'dark' || (!saved && prefersDark)) {
        document.documentElement.setAttribute('data-theme', 'dark');
      }
    })();
  </script>
</head>
<body>

<header class="header">
    <h1>üì¢ –¢–µ–ª–µ–≥—Ä–∞–º-–∫–∞–Ω–∞–ª –∞–¥–≤–æ–∫–∞—Ç–∞ –í–∞–ª–µ—Ä–∏—è –§–µ–¥–æ—Ä–æ–≤–∞</h1>
    <div class="header-sub">–ü–æ—Å—Ç—ã –∏–∑ –∫–∞–Ω–∞–ª–∞ <a href="https://t.me/adv_vfedorov" target="_blank">@adv_vfedorov</a></div>
</header>

<main class="wrap">
    <div class="toolbar">
        <input class="search" id="q" type="text" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –ø–æ—Å—Ç–∞–º‚Ä¶">
        <span class="info" id="info"></span>
    </div>
    <div id="feed">
        <div class="status" id="loader"><div class="spinner"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤‚Ä¶</p></div>
    </div>
    <button class="btn-more" id="more">–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë</button>
</main>

<button class="btn-top" id="top" onclick="scrollTo({top:0,behavior:'smooth'})">‚Üë</button>
<div class="lb" id="lb" onclick="this.classList.remove('open')"><img id="lbImg" src="" alt=""></div>
<div class="footer">–ò—Å—Ç–æ—á–Ω–∏–∫: <a href="https://t.me/adv_vfedorov" target="_blank">t.me/adv_vfedorov</a> ¬∑ –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</div>

<script>
(function(){
    const BATCH = 20;
    let posts=[], vis=[], shown=0, query='';

    const $f=document.getElementById('feed'),
          $l=document.getElementById('loader'),
          $i=document.getElementById('info'),
          $m=document.getElementById('more'),
          $q=document.getElementById('q'),
          $t=document.getElementById('top'),
          $lb=document.getElementById('lb'),
          $li=document.getElementById('lbImg');

    /* Load pre-scraped JSON */
    fetch('posts.json')
        .then(r=>{if(!r.ok)throw new Error(r.status);return r.json()})
        .then(data=>{
            posts=data.sort((a,b)=>b.id-a.id);
            $l.remove();
            if(!posts.length){$f.innerHTML='<div class="empty">–ü–æ—Å—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';return;}
            doFilter();
        })
        .catch(e=>{
            $l.innerHTML=`<p class="err">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}</p>
                <button class="retry" onclick="location.reload()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
                <p style="margin-top:14px"><a href="https://t.me/adv_vfedorov" target="_blank" style="color:var(--accent);font-size:13px">–û—Ç–∫—Ä—ã—Ç—å –∫–∞–Ω–∞–ª –≤ Telegram ‚Üí</a></p>`;
        });

    function doFilter(){
        const lq=query.toLowerCase();
        vis=lq?posts.filter(p=>strip(p.text).toLowerCase().includes(lq)):[...posts];
        shown=0; $f.innerHTML='';
        $i.textContent=vis.length+' –ø–æ—Å—Ç'+plu(vis.length);
        if(!vis.length){$f.innerHTML='<div class="empty">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';$m.style.display='none';return;}
        batch();
    }

    function batch(){
        const end=Math.min(shown+BATCH,vis.length);
        for(let i=shown;i<end;i++) $f.appendChild(mkCard(vis[i]));
        shown=end;
        $m.style.display=shown<vis.length?'block':'none';
        if(shown<vis.length) $m.textContent=`–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë (${vis.length-shown})`;
    }

    function mkCard(p){
        const el=document.createElement('div'); el.className='card';
        let body=p.text||'';
        if(query) body=hl(body,query);

        let media='';
        if(p.photo) media=`<div class="card-photo" onclick="openLb('${esc(p.photo)}')"><img src="${esc(p.photo)}" alt="" loading="lazy"></div>`;
        else if(p.video) media=`<div class="card-video"><video src="${esc(p.video)}" controls preload="none"></video></div>`;

        let foot='';
        if(p.views) foot=`<div class="card-views"><svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>${p.views}</div>`;

        const link=`https://t.me/adv_vfedorov/${p.id}`;
        el.innerHTML=`<div class="card-head"><span class="card-date">${fmtD(p.date)}</span><a class="card-link" href="${link}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å ‚Üó</a></div>${body?`<div class="card-body">${body}</div>`:''}${media}${foot}`;
        return el;
    }

    function fmtD(s){if(!s)return'';const d=new Date(s);if(isNaN(d))return s;return d.toLocaleDateString('ru-RU',{day:'numeric',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit'});}
    function strip(h){return(h||'').replace(/<[^>]*>/g,'');}
    function esc(s){return s.replace(/'/g,"\\'");}
    function hl(h,q){const e=q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),r=new RegExp(`(${e})`,'gi');return h.replace(/>([^<]*)</g,(f,t)=>'>'+t.replace(r,'<mark>$1</mark>')+'<');}
    function plu(n){const m=n%100;if(m>=11&&m<=19)return'–æ–≤';const l=n%10;if(l===1)return'';if(l>=2&&l<=4)return'–∞';return'–æ–≤';}

    window.openLb=function(s){$li.src=s;$lb.classList.add('open');};
    $m.onclick=batch;
    let deb;$q.addEventListener('input',()=>{clearTimeout(deb);deb=setTimeout(()=>{query=$q.value.trim();doFilter();},250);});
    addEventListener('scroll',()=>{$t.classList.toggle('show',scrollY>500);},{passive:true});
    document.addEventListener('keydown',e=>{if(e.key==='Escape')$lb.classList.remove('open');});
})();
</script>
</body>
</html>