<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram ‚Äî adv_vfedorov</title>
    <style>
        :root {
            --bg: #f5f5f5;
            --card-bg: #ffffff;
            --text: #222222;
            --text-secondary: #888888;
            --accent: #2AABEE;
            --accent-hover: #1d96d1;
            --border: #e8e8e8;
            --shadow: rgba(0, 0, 0, 0.06);
            --mark-bg: #fff3cd;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.65;
            -webkit-font-smoothing: antialiased;
        }

        /* ===== HEADER ===== */
        .header {
            background: linear-gradient(135deg, #2AABEE 0%, #1b8ec7 100%);
            color: #fff;
            padding: 28px 20px 24px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
        }

        .header-inner {
            max-width: 680px;
            margin: 0 auto;
        }

        .header h1 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 4px;
            letter-spacing: -0.3px;
        }

        .header-sub {
            font-size: 13px;
            opacity: 0.85;
        }

        .header-sub a {
            color: #fff;
            text-decoration: underline;
            text-decoration-style: dashed;
            text-underline-offset: 3px;
        }

        /* ===== CONTAINER ===== */
        .container {
            max-width: 680px;
            margin: 0 auto;
            padding: 16px 12px 40px;
        }

        /* ===== SEARCH ===== */
        .toolbar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 180px;
            padding: 10px 14px;
            font-size: 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            outline: none;
            background: var(--card-bg);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .search-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(42, 171, 238, 0.12);
        }

        .counter {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        /* ===== LOADING / ERROR ===== */
        .status-box {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            width: 36px;
            height: 36px;
            border: 3.5px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            margin: 0 auto 14px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .status-box p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .status-box .err {
            color: #d9534f;
        }

        .retry-btn {
            margin-top: 14px;
            padding: 9px 24px;
            font-size: 14px;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .retry-btn:hover {
            background: var(--accent-hover);
        }

        /* ===== POST CARD ===== */
        .post {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 18px 20px;
            margin-bottom: 12px;
            box-shadow: 0 1px 4px var(--shadow);
            transition: box-shadow 0.2s;
            overflow-wrap: break-word;
            word-break: break-word;
        }

        .post:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.09);
        }

        .post-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .post-date {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .post-link {
            font-size: 12px;
            color: var(--accent);
            text-decoration: none;
        }

        .post-link:hover {
            text-decoration: underline;
        }

        /* text */
        .post-body {
            font-size: 15px;
            line-height: 1.72;
        }

        .post-body a {
            color: var(--accent);
            text-decoration: none;
        }

        .post-body a:hover {
            text-decoration: underline;
        }

        .post-body b,
        .post-body strong {
            font-weight: 600;
        }

        .post-body i,
        .post-body em {
            font-style: italic;
        }

        .post-body blockquote {
            border-left: 3px solid var(--accent);
            margin: 8px 0;
            padding: 4px 14px;
            background: #f8f9fa;
            border-radius: 0 8px 8px 0;
        }

        .post-body pre {
            background: #f4f4f4;
            padding: 10px 14px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 13px;
            margin: 8px 0;
        }

        .post-body code {
            background: #f0f0f0;
            padding: 1px 5px;
            border-radius: 3px;
            font-size: 13px;
        }

        .post-body br + br {
            display: block;
            content: "";
            margin-top: 6px;
        }

        /* media */
        .post-media {
            margin-top: 12px;
            border-radius: 8px;
            overflow: hidden;
            line-height: 0;
        }

        .post-media img,
        .post-media video {
            width: 100%;
            border-radius: 8px;
            display: block;
        }

        .post-media img {
            cursor: pointer;
        }

        /* views */
        .post-footer {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
            font-size: 12px;
            color: #bbb;
        }

        .post-footer svg {
            width: 14px;
            height: 14px;
            fill: #bbb;
        }

        /* ===== LOAD MORE ===== */
        .load-more-btn {
            display: block;
            width: 100%;
            padding: 13px;
            margin-top: 4px;
            margin-bottom: 20px;
            font-size: 14px;
            color: var(--accent);
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .load-more-btn:hover {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        .load-more-btn:disabled {
            opacity: 0.45;
            cursor: default;
        }

        /* ===== NO RESULTS ===== */
        .no-results {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        /* ===== SCROLL TOP ===== */
        .scroll-top {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 44px;
            height: 44px;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.18);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .scroll-top.show {
            opacity: 1;
            pointer-events: auto;
        }

        /* ===== LIGHTBOX ===== */
        .lightbox {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.88);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: zoom-out;
        }

        .lightbox.open {
            display: flex;
        }

        .lightbox img {
            max-width: 94vw;
            max-height: 94vh;
            border-radius: 6px;
        }

        /* ===== FOOTER ===== */
        .footer {
            text-align: center;
            padding: 10px 20px 30px;
            font-size: 11px;
            color: #bbb;
        }

        .footer a {
            color: var(--accent);
            text-decoration: none;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 520px) {
            .header { padding: 20px 14px 18px; }
            .header h1 { font-size: 19px; }
            .post { padding: 14px 15px; border-radius: 10px; }
            .container { padding: 12px 8px 30px; }
        }
    </style>
</head>
<body>

<!-- HEADER -->
<div class="header">
    <div class="header-inner">
        <h1>üì¢ adv_vfedorov</h1>
        <div class="header-sub">
            –ü–æ—Å—Ç—ã –∏–∑ Telegram-–∫–∞–Ω–∞–ª–∞
            <a href="https://t.me/adv_vfedorov" target="_blank" rel="noopener">@adv_vfedorov</a>
        </div>
    </div>
</div>

<!-- MAIN -->
<div class="container">
    <div class="toolbar">
        <input class="search-input" id="search" type="text" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –ø–æ—Å—Ç–∞–º‚Ä¶">
        <span class="counter" id="counter"></span>
    </div>

    <div id="feed">
        <div class="status-box" id="loader">
            <div class="spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤‚Ä¶</p>
        </div>
    </div>

    <button class="load-more-btn" id="moreBtn" style="display:none" onclick="showMore()">–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë</button>
</div>

<!-- SCROLL-TOP -->
<button class="scroll-top" id="scrollBtn" onclick="window.scrollTo({top:0,behavior:'smooth'})">‚Üë</button>

<!-- LIGHTBOX -->
<div class="lightbox" id="lightbox" onclick="this.classList.remove('open')">
    <img id="lightboxImg" src="" alt="">
</div>

<!-- FOOTER -->
<div class="footer">
    –ò—Å—Ç–æ—á–Ω–∏–∫: <a href="https://t.me/adv_vfedorov" target="_blank">t.me/adv_vfedorov</a>
</div>

<script>
(function () {
    'use strict';

    /* ‚îÄ‚îÄ config ‚îÄ‚îÄ */
    const CHANNEL   = 'adv_vfedorov';
    const PAGE_SIZE = 20;

    /* ‚îÄ‚îÄ state ‚îÄ‚îÄ */
    let allPosts     = [];
    let filtered     = [];
    let shown        = 0;
    let searchQuery  = '';

    /* ‚îÄ‚îÄ DOM refs ‚îÄ‚îÄ */
    const $feed    = document.getElementById('feed');
    const $loader  = document.getElementById('loader');
    const $counter = document.getElementById('counter');
    const $more    = document.getElementById('moreBtn');
    const $search  = document.getElementById('search');
    const $scroll  = document.getElementById('scrollBtn');
    const $lb      = document.getElementById('lightbox');
    const $lbImg   = document.getElementById('lightboxImg');

    /* ‚îÄ‚îÄ CORS proxies (same approach as the reference site) ‚îÄ‚îÄ */
    const proxies = [
        u => 'https://api.allorigins.win/raw?url=' + encodeURIComponent(u),
        u => 'https://corsproxy.io/?' + encodeURIComponent(u),
        u => 'https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(u),
        u => 'https://crossorigin.me/' + u,
    ];

    /* ‚îÄ‚îÄ fetch with fallback ‚îÄ‚îÄ */
    async function grab(url, timeout = 12000) {
        for (const px of proxies) {
            try {
                const r = await fetch(px(url), { signal: AbortSignal.timeout(timeout) });
                if (r.ok) {
                    const t = await r.text();
                    if (t && t.length > 200) return t;
                }
            } catch (_) { /* next */ }
        }
        throw new Error('all proxies failed');
    }

    /* ‚îÄ‚îÄ parse t.me/s/ HTML ‚îÄ‚îÄ */
    function parseHTML(html) {
        const doc  = new DOMParser().parseFromString(html, 'text/html');
        const msgs = doc.querySelectorAll('.tgme_widget_message_wrap');
        const out  = [];

        msgs.forEach(wrap => {
            const bubble = wrap.querySelector('.tgme_widget_message_bubble');
            if (!bubble) return;

            /* text */
            const textEl = bubble.querySelector('.tgme_widget_message_text');
            let text = textEl ? textEl.innerHTML.trim() : '';

            /* date */
            const timeEl = bubble.querySelector('time[datetime]');
            const dt = timeEl ? new Date(timeEl.getAttribute('datetime')) : null;

            /* link */
            const linkEl = bubble.querySelector('a.tgme_widget_message_date');
            const link = linkEl ? linkEl.getAttribute('href') : '';

            /* views */
            const viewsEl = bubble.querySelector('.tgme_widget_message_views');
            const views = viewsEl ? viewsEl.textContent.trim() : '';

            /* photo */
            let photoUrl = '';
            const photoWrap = bubble.querySelector('.tgme_widget_message_photo_wrap');
            if (photoWrap) {
                const st = photoWrap.getAttribute('style') || '';
                const m  = st.match(/url\(['"]?(.*?)['"]?\)/);
                if (m) photoUrl = m[1];
            }

            /* video */
            let videoUrl = '';
            const videoEl = bubble.querySelector('video');
            if (videoEl) videoUrl = videoEl.getAttribute('src') || '';

            /* round video / voice ‚Äî skip if completely empty */
            if (!text && !photoUrl && !videoUrl) return;

            const msgEl = wrap.querySelector('.tgme_widget_message');
            const dataPost = msgEl ? msgEl.getAttribute('data-post') : '';
            const postId = dataPost ? dataPost.split('/').pop() : '';

            out.push({ text, date: dt, link, views, photoUrl, videoUrl, id: postId });
        });

        return out;
    }

    /* ‚îÄ‚îÄ load ALL posts by scrolling back ‚îÄ‚îÄ */
    async function loadAllPosts() {
        let url = `https://t.me/s/${CHANNEL}`;
        let allLoaded = [];
        let seenIds = new Set();
        let attempts = 0;
        const MAX_ATTEMPTS = 200;        // safety limit

        // First load ‚Äî latest posts
        let html = await grab(url);
        let posts = parseHTML(html);

        posts.forEach(p => {
            if (p.id && !seenIds.has(p.id)) {
                seenIds.add(p.id);
                allLoaded.push(p);
            }
        });

        // Walk backwards using "before" parameter
        while (attempts < MAX_ATTEMPTS) {
            attempts++;
            // find the smallest id we have
            const ids = allLoaded.map(p => parseInt(p.id)).filter(n => !isNaN(n) && n > 0);
            if (ids.length === 0) break;
            const minId = Math.min(...ids);
            if (minId <= 1) break;

            const olderUrl = `https://t.me/s/${CHANNEL}?before=${minId}`;
            try {
                html = await grab(olderUrl, 15000);
            } catch (_) {
                break;
            }

            posts = parseHTML(html);
            if (posts.length === 0) break;

            let added = 0;
            posts.forEach(p => {
                if (p.id && !seenIds.has(p.id)) {
                    seenIds.add(p.id);
                    allLoaded.push(p);
                    added++;
                }
            });

            if (added === 0) break;

            // update loading indicator
            $loader.querySelector('p').textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allLoaded.length} –ø–æ—Å—Ç–æ–≤‚Ä¶`;
        }

        // sort newest first
        allLoaded.sort((a, b) => {
            const ia = parseInt(a.id) || 0;
            const ib = parseInt(b.id) || 0;
            return ib - ia;
        });

        return allLoaded;
    }

    /* ‚îÄ‚îÄ render helpers ‚îÄ‚îÄ */
    function fmtDate(d) {
        if (!d || isNaN(d)) return '';
        return d.toLocaleDateString('ru-RU', {
            day: 'numeric', month: 'long', year: 'numeric',
            hour: '2-digit', minute: '2-digit'
        });
    }

    function highlight(html, q) {
        if (!q) return html;
        // We highlight only in visible text, not inside tags
        const esc = q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const re  = new RegExp(`(${esc})`, 'gi');
        // split by tags, highlight only text parts
        return html.replace(/>([^<]*)</g, (full, txt) => {
            return '>' + txt.replace(re, '<mark style="background:var(--mark-bg);padding:0 2px;border-radius:2px">$1</mark>') + '<';
        });
    }

    function buildCard(p) {
        const card = document.createElement('div');
        card.className = 'post';

        let body = p.text;
        if (searchQuery) body = highlight(body, searchQuery);

        let media = '';
        if (p.photoUrl) {
            media = `<div class="post-media"><img src="${p.photoUrl}" alt="" loading="lazy" onclick="openLightbox(this.src)"></div>`;
        } else if (p.videoUrl) {
            media = `<div class="post-media"><video src="${p.videoUrl}" controls preload="none"></video></div>`;
        }

        let footer = '';
        if (p.views) {
            footer = `<div class="post-footer">
                <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                ${p.views}
            </div>`;
        }

        card.innerHTML = `
            <div class="post-head">
                <span class="post-date">${fmtDate(p.date)}</span>
                ${p.link ? `<a class="post-link" href="${p.link}" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å ‚Üó</a>` : ''}
            </div>
            ${body ? `<div class="post-body">${body}</div>` : ''}
            ${media}
            ${footer}
        `;
        return card;
    }

    /* ‚îÄ‚îÄ rendering ‚îÄ‚îÄ */
    function applyFilter() {
        const q = searchQuery.toLowerCase();
        filtered = q
            ? allPosts.filter(p => {
                const plain = p.text.replace(/<[^>]*>/g, '').toLowerCase();
                return plain.includes(q);
            })
            : [...allPosts];

        shown = 0;
        $feed.innerHTML = '';
        $counter.textContent = filtered.length + ' –ø–æ—Å—Ç' + pluralRu(filtered.length);

        if (filtered.length === 0) {
            $feed.innerHTML = '<div class="no-results">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
            $more.style.display = 'none';
            return;
        }

        appendBatch();
    }

    function appendBatch() {
        const end = Math.min(shown + PAGE_SIZE, filtered.length);
        for (let i = shown; i < end; i++) {
            $feed.appendChild(buildCard(filtered[i]));
        }
        shown = end;
        if (shown < filtered.length) {
            $more.style.display = 'block';
            $more.textContent = `–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë (–æ—Å—Ç–∞–ª–æ—Å—å ${filtered.length - shown})`;
        } else {
            $more.style.display = 'none';
        }
    }

    function pluralRu(n) {
        const m = n % 100;
        if (m >= 11 && m <= 19) return '–æ–≤';
        const l = n % 10;
        if (l === 1) return '';
        if (l >= 2 && l <= 4) return '–∞';
        return '–æ–≤';
    }

    /* ‚îÄ‚îÄ public ‚îÄ‚îÄ */
    window.showMore = appendBatch;

    window.openLightbox = function (src) {
        $lbImg.src = src;
        $lb.classList.add('open');
    };

    /* ‚îÄ‚îÄ search ‚îÄ‚îÄ */
    let debounce;
    $search.addEventListener('input', () => {
        clearTimeout(debounce);
        debounce = setTimeout(() => {
            searchQuery = $search.value.trim();
            applyFilter();
        }, 250);
    });

    /* ‚îÄ‚îÄ scroll-top button ‚îÄ‚îÄ */
    window.addEventListener('scroll', () => {
        $scroll.classList.toggle('show', window.scrollY > 600);
    }, { passive: true });

    /* ‚îÄ‚îÄ ESC closes lightbox ‚îÄ‚îÄ */
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') $lb.classList.remove('open');
    });

    /* ‚îÄ‚îÄ error UI ‚îÄ‚îÄ */
    function showError(msg) {
        $feed.innerHTML = `
            <div class="status-box">
                <p class="err">üòî ${msg}</p>
                <p style="margin-top:6px;font-size:13px;color:#999">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</p>
                <button class="retry-btn" onclick="location.reload()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
                <p style="margin-top:14px">
                    <a href="https://t.me/${CHANNEL}" target="_blank" style="color:var(--accent);font-size:13px">
                        –û—Ç–∫—Ä—ã—Ç—å –∫–∞–Ω–∞–ª –≤ Telegram ‚Üí
                    </a>
                </p>
            </div>`;
    }

    /* ‚îÄ‚îÄ INIT ‚îÄ‚îÄ */
    async function init() {
        try {
            allPosts = await loadAllPosts();
            $loader.remove();

            if (allPosts.length === 0) {
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ—Å—Ç—ã');
                return;
            }

            applyFilter();
        } catch (err) {
            console.error(err);
            $loader.remove();
            showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + err.message);
        }
    }

    init();
})();
</script>
</body>
</html>